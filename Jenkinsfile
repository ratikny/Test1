pipeline {
    // Указываем, что сборка может выполняться на любом доступном агенте Jenkins
    agent any

    // Определяем инструменты, которые нужны для сборки
    tools {
        // Правильное имя Maven, которое мы настроили в Jenkins
        maven 'Maven-3.9.8'
    }

    stages {
        // Этап 1: Скачивание кода из репозитория
        // Jenkins автоматически скачает код из того репозитория,
        // который вы указали в настройках Pipeline
        stage('Checkout') {
            steps {
                echo "Забираем проект из Git..."
                checkout scm
            }
        }

        // Этап 2: Сборка и запуск тестов
        stage('Build & Test') {
            steps {
                echo "Собираем проект и запускаем тесты..."
                // Команда 'mvn clean install' сначала очистит проект,
                // а потом соберёт его и запустит тесты
                sh 'mvn clean install'
            }
        }
    }

    // Блок, который выполняется после всех этапов
    post {
        // Выполняется всегда, независимо от успеха или провала сборки
        always {
            echo "Сохраняем результаты тестов..."
            // Собираем отчёты о тестах для отображения в интерфейсе Jenkins
            junit 'target/surefire-reports/*.xml'

            echo "Убираем временные файлы..."
            cleanWs()
        }
        success {
            echo "Все шаги прошли успешно!"
        }
        failure {
            echo "Ошибка! Проверь логи."
        }
    }
}